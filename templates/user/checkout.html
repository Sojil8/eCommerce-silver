<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Silver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js" crossorigin="anonymous" defer></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js" defer></script>
    <style>
        /* Custom Styles & Tailwind Overrides */
        .swal2-container { z-index: 9999; }
        .key-value-pair { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; font-size: 0.9rem; }
        .key-value-pair .key { font-weight: 600; color: #4b5563; }
        .key-value-pair .value { color: #1f2937; }
        .coupon-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .coupon-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .btn-primary { @apply bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-full hover:from-purple-700 hover:to-indigo-700 transition-all duration-300 shadow-lg font-semibold; }
        .btn-secondary { @apply bg-gray-200 text-gray-700 px-6 py-3 rounded-full hover:bg-gray-300 transition-all duration-300 font-semibold; }
        .section-header { @apply text-2xl font-bold text-gray-900 mb-6 flex items-center; }
        .input-field { @apply w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-200 focus:border-purple-500 transition-all text-gray-800; }
        .card { @apply bg-white rounded-2xl shadow-xl p-6 sm:p-8 border border-gray-100; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-container { background-color: white; border-radius: 1.5rem; padding: 2rem; width: 95%; max-width: 42rem; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-container { transform: scale(1); }
        .form-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; }
        @media (min-width: 640px) {
            .form-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen font-sans antialiased">
    {{template "navbar.html" .}}

    <main class="container mx-auto p-4 sm:p-6 flex-grow max-w-7xl">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-12 text-gray-900 leading-tight">
            Complete Your Purchase üõçÔ∏è
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <section class="order-summary card">
                <h2 class="section-header">
                    <i class="fas fa-shopping-cart text-indigo-600 mr-3"></i> Order Summary
                </h2>
                <hr class="border-gray-200 mb-6">
                {{if .Cart.CartItems}}
                <div class="space-y-6">
                    {{range .Cart.CartItems}}
                    {{if .Product.InStock}}
                    <div class="flex items-start border-b pb-4 last:border-b-0 hover:bg-gray-50 transition-colors rounded-lg -mx-2 px-2">
                        <img src="{{index .Product.Images 0}}" alt="{{.Product.ProductName}}" class="w-20 h-20 object-cover rounded-lg border mr-4 shadow-sm" loading="lazy">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900">{{.Product.ProductName}}</h3>
                            <p class="text-gray-600 text-sm mt-1">
                                <span class="font-medium">Quantity:</span> {{.Quantity}}
                                <span class="ml-4 font-medium">Color:</span> {{.Variants.Color}}
                            </p>
                            <div class="mt-2 flex items-center space-x-3">
                                <p class="text-purple-600 font-bold text-lg">${{printf "%.2f" (mul .DiscountedPrice .Quantity)}}</p>
                                {{if .IsOfferApplied}}
                                <p class="text-gray-500 line-through text-sm">${{printf "%.2f" (mul .RegularPrice .Quantity)}}</p>
                                {{end}}
                            </div>
                        </div>
                    </div>
                    {{end}}
                    {{end}}
                    {{if .HasInvalidItems}}
                    <p class="text-red-600 text-sm mt-4">Some items are out of stock and not included in the order.</p>
                    {{end}}
                </div>
                <hr class="border-gray-200 mt-6 mb-6">

                <div class="mt-8 pt-0">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-receipt text-indigo-600 mr-2"></i> Price Breakdown
                    </h4>
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Original Cart Total</span>
                            <span class="font-semibold text-gray-900" id="originalTotal">${{printf "%.2f" .OriginalTotalPrice}}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal (After offers)</span>
                            <span class="font-semibold text-gray-900" id="subtotal">${{printf "%.2f" .Cart.TotalPrice}}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-green-600">Offer Discounts</span>
                            <span class="font-semibold text-green-600" id="productDiscount">-${{printf "%.2f" .OfferDiscount}}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Shipping</span>
                            <span class="font-semibold text-gray-900" id="shipping">${{printf "%.2f" .Shipping}}</span>
                        </div>
                        <div class="flex justify-between" id="couponDiscountRow" style="display: {{if .CouponDiscount}}flex{{else}}none{{end}};">
                            <span class="text-green-600">Coupon Discount</span>
                            <span class="font-semibold text-green-600" id="couponDiscount">-${{printf "%.2f" .CouponDiscount}}</span>
                        </div>
                        <div class="flex justify-between border-t pt-4 mt-4">
                            <span class="text-xl font-bold text-gray-900">Grand Total</span>
                            <span class="text-xl font-bold text-purple-600" id="finalTotal">${{printf "%.2f" .FinalPrice}}</span>
                        </div>
                    </div>
                </div>
                {{else}}
                <p class="text-gray-500 text-center py-8 text-lg">Your cart is empty. üõí</p>
                {{end}}
            </section>

            <section class="billing-details card">
                <h2 class="section-header">
                    <i class="fas fa-map-marker-alt text-indigo-600 mr-3"></i> Delivery & Payment
                </h2>
                <hr class="border-gray-200 mb-6">

                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-user-circle text-indigo-600 mr-2"></i> Customer Information
                    </h4>
                    <div class="space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="key-value-pair"><span class="key">Name</span><span class="value">{{.UserName}}</span></div>
                        <div class="key-value-pair"><span class="key">Email</span><span class="value">{{.UserEmail}}</span></div>
                        <div class="key-value-pair"><span class="key">Phone</span><span class="value">{{.UserPhone}}</span></div>
                        <div class="key-value-pair"><span class="key">Wallet Balance</span><span class="value" id="walletBalance">${{printf "%.2f" .Wallet.Balance }}</span></div>
                    </div>
                </div>

                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">Shipping Address</h4>
                        {{if .Addresses}}
                        <button onclick="showAddressModal()" class="btn-secondary py-1.5 px-4 text-sm whitespace-nowrap">Add New</button>
                        {{end}}
                    </div>
                    {{if .Addresses}}
                    <div class="space-y-4">
                        <select id="addressSelect" onchange="selectAddress(this.value)" class="input-field" aria-label="Select shipping address">
                            <option value="">Select an address</option>
                            {{range .Addresses}}
                            <option value="{{.ID}}" {{if .IsDefault}}selected{{end}}>
                                {{.Name}} ({{.AddressType}}) - {{.City}}, {{.State}} - {{.Pincode}}
                            </option>
                            {{end}}
                        </select>
                        <button onclick="showAddressModal(document.getElementById('addressSelect').value)" class="btn-secondary w-full">Edit Selected Address</button>
                    </div>
                    {{else}}
                    <p class="text-gray-500 text-sm">No addresses found. Please add one. üè†</p>
                    <button onclick="showAddressModal()" class="btn-primary w-full mt-4">Add New Address</button>
                    {{end}}
                </div>
                
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4 cursor-pointer flex justify-between items-center" onclick="toggleCoupons()">
                        <span><i class="fas fa-tag text-indigo-600 mr-2"></i> Coupons & Discounts</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                    </h4>
                    <div id="couponSection" class="space-y-4 {{if not .CouponApplied}}hidden{{end}} animate-fade-in">
                        <div id="couponContainer">
                            <div id="appliedCouponUI" class="flex items-center justify-between bg-green-50 text-green-700 p-4 rounded-xl border border-green-200 {{if not .CouponApplied}}hidden{{end}}">
                                <div>
                                    <p class="font-medium text-base">Coupon: <span id="appliedCouponCodeDisplay">{{.AppliedCoupon.CouponCode}}</span></p>
                                    <p class="text-sm"><span id="appliedCouponSavedAmount">Saved: ${{printf "%.2f" .CouponDiscount}}</span></p>
                                </div>
                                <button onclick="removeCoupon()" class="btn-secondary bg-red-100 text-red-700 hover:bg-red-200 py-1.5 px-4">Remove</button>
                            </div>

                            <div id="couponInputUI" class="{{if .CouponApplied}}hidden{{end}}">
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <input type="text" id="couponCode" placeholder="Enter coupon code" class="input-field flex-1" aria-label="Coupon code">
                                    <button onclick="applyCoupon()" class="btn-primary whitespace-nowrap">Apply</button>
                                </div>
                                <p id="couponMessage" class="mt-2 text-xs sm:text-sm text-gray-600 hidden"></p>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <h5 class="text-sm sm:text-base font-semibold text-gray-900 mb-3">Available Coupons</h5>
                            <div id="availableCoupons" class="space-y-3">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-wallet text-indigo-600 mr-2"></i> Choose Payment Method
                    </h4>
                    <select id="paymentMethod" class="input-field" aria-label="Select payment method">
                        <option value="COD">Cash on Delivery (COD)</option>
                        <option value="ONLINE">Online Payment (Razorpay)</option>
                        <option value="WALLET">Wallet Payment</option>
                    </select>
                </div>
                
                <div>
                    <button id="placeOrderBtn" class="btn-primary w-full py-4 text-base font-semibold flex items-center justify-center">
                        <i class="fas fa-lock mr-2"></i> Securely Place Order
                    </button>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-gray-900 text-white p-6 sm:p-8 mt-auto">
        <div class="container mx-auto text-center">
            <p class="text-xs sm:text-sm">¬© 2025 Silver. All rights reserved. ‚ú®</p>
        </div>
    </footer>

    <div id="addressModal" class="modal-overlay" onclick="closeAddressModal(event)">
        <div class="modal-container">
            <h2 id="modalTitle" class="text-2xl font-bold text-center text-purple-600 mb-6"></h2>
            <form id="addressForm" class="space-y-6">
                <div class="form-grid">
                    <div>
                        <label for="address_type" class="block text-sm font-medium text-gray-700 mb-1">Address Type</label>
                        <select id="address_type" name="address_type" required class="input-field">
                            <option value="Home">Home</option>
                            <option value="Work">Work</option>
                        </select>
                    </div>
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="name" name="name" required class="input-field">
                    </div>
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                        <input type="text" id="city" name="city" required class="input-field">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <input type="text" id="state" name="state" required class="input-field">
                    </div>
                    <div>
                        <label for="pincode" class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
                        <input type="text" id="pincode" name="pincode" required class="input-field">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="phone" name="phone" maxlength="10" pattern="[0-9]{10}" required class="input-field">
                    </div>
                    <div>
                        <label for="alternate_phone" class="block text-sm font-medium text-gray-700 mb-1">Alternate Phone (Optional)</label>
                        <input type="tel" id="alternate_phone" name="alternate_phone" maxlength="10" class="input-field">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="landmark" class="block text-sm font-medium text-gray-700 mb-1">Landmark (Optional)</label>
                        <input type="text" id="landmark" name="landmark" class="input-field">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeAddressModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" id="modalSaveBtn" class="btn-primary">Save Address</button>
                </div>
            </form>
        </div>
    </div>

   <script>
    // Initialize state from Go template variables
    let state = {
        selectedAddressId: "{{range .Addresses}}{{if .IsDefault}}{{.ID}}{{end}}{{end}}",
        originalTotalPrice: Number("{{printf "%.2f" .OriginalTotalPrice}}"),
        subtotal: Number("{{printf "%.2f" .Cart.TotalPrice}}"),
        shipping: Number("{{printf "%.2f" .Shipping}}"),
        offerDiscount: Number("{{printf "%.2f" .OfferDiscount}}"),
        couponDiscount: Number("{{printf "%.2f" .CouponDiscount}}"),
        totalDiscount: Number("{{printf "%.2f" .TotalDiscount}}"),
        finalTotal: Number("{{printf "%.2f" .FinalPrice}}"),
        appliedCoupon: {{if .CouponApplied}}true{{else}}false{{end}},
        appliedCouponCode: "{{.AppliedCoupon.CouponCode}}",
        walletBalance: Number("{{printf "%.2f" .WalletBalance}}")
    };

    // DOM element helpers
    const getElement = (id) => {
        const element = document.getElementById(id);
        if (!element) console.warn(`Element with id '${id}' not found`);
        return element;
    };

    const safeSetText = (element, text) => {
        if (element) element.textContent = text;
    };

    const safeSetDisplay = (element, display) => {
        if (element) element.style.display = display;
    };

    const safeToggleClass = (element, className, add = true) => {
        if (element) element.classList[add ? 'add' : 'remove'](className);
    };

    // DOM elements
    const els = {
        addressSelect: getElement('addressSelect'),
        couponCode: getElement('couponCode'),
        couponMessage: getElement('couponMessage'),
        availableCoupons: getElement('availableCoupons'),
        couponDiscountRow: getElement('couponDiscountRow'),
        couponDiscount: getElement('couponDiscount'),
        originalTotal: getElement('originalTotal'),
        subtotalDisplay: getElement('subtotal'),
        finalTotal: getElement('finalTotal'),
        paymentMethod: getElement('paymentMethod'),
        couponSection: getElement('couponSection'),
        couponContainer: getElement('couponContainer'),
        placeOrderBtn: getElement('placeOrderBtn'),
        addressModal: getElement('addressModal'),
        modalTitle: getElement('modalTitle'),
        addressForm: getElement('addressForm'),
        appliedCouponUI: getElement('appliedCouponUI'),
        couponInputUI: getElement('couponInputUI'),
        appliedCouponCodeDisplay: getElement('appliedCouponCodeDisplay'),
        appliedCouponSavedAmount: getElement('appliedCouponSavedAmount'),
        walletBalance: getElement('walletBalance')
    };

    // SweetAlert helper
    const showAlert = (icon, title, text, timer = 0) => {
        const config = {
            icon,
            title,
            text,
            confirmButtonColor: '#6b21a8',
            toast: timer > 0,
            position: 'top-end',
            showConfirmButton: false
        };
        if (timer) config.timer = timer;
        return Swal.fire(config);
    };

    // Loading spinner helpers
    const showLoading = () => {
        Swal.fire({ title: 'Processing', text: 'Please wait...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    };

    const closeLoading = () => Swal.close();

    // API call helper
    const apiCall = async (url, method, body = null) => {
        const options = {
            method,
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        };
        if (body) options.body = JSON.stringify(body);

        try {
            const response = await fetch(url, options);
            let data;
            try {
                data = await response.json();
            } catch (parseError) {
                console.error(`Failed to parse JSON response from ${url}:`, parseError);
                throw new Error('Server returned invalid response');
            }
            console.log(`API call to ${url} returned status ${response.status}:`, data);
            return data;
        } catch (networkError) {
            console.error(`Network Error for ${url}:`, networkError);
            throw new Error('Network connection failed');
        }
    };

    // Toggle coupon section visibility
    function toggleCoupons() {
        if (els.couponSection) {
            els.couponSection.classList.toggle('hidden');
            const chevronIcon = els.couponSection.previousElementSibling?.querySelector('.fa-chevron-down');
            if (chevronIcon) chevronIcon.classList.toggle('rotate-180');
        }
    }

    // Update coupon UI state
    function updateCouponUI(isApplied, couponCode = '', discount = 0) {
        if (isApplied) {
            safeToggleClass(els.appliedCouponUI, 'hidden', false);
            safeToggleClass(els.couponInputUI, 'hidden', true);
            safeToggleClass(els.couponMessage, 'hidden', true);
            safeSetText(els.appliedCouponCodeDisplay, couponCode);
            safeSetText(els.appliedCouponSavedAmount, `Saved: $${discount.toFixed(2)}`);
        } else {
            safeToggleClass(els.appliedCouponUI, 'hidden', true);
            safeToggleClass(els.couponInputUI, 'hidden', false);
        }
    }

    // Fetch and display available coupons
    async function fetchCoupons() {
        try {
            const data = await apiCall('/checkout/available-coupons', 'GET');
            if (els.availableCoupons) {
                els.availableCoupons.innerHTML = data.status === 'ok' && data.coupons.length
                    ? data.coupons.map(coupon => `
                        <div class="coupon-card flex items-center justify-between p-3 bg-white rounded-lg border">
                            <div>
                                <p class="font-medium ${coupon.is_used ? 'text-gray-500' : 'text-gray-800'} text-sm">
                                    ${coupon.coupon_code}
                                </p>
                                <p class="text-xs text-gray-600">
                                    Save ${coupon.discount_percentage}% (Min. $${coupon.min_purchase_amount.toFixed(2)})
                                </p>
                            </div>
                            ${!coupon.is_used && !state.appliedCoupon ? `<button onclick="applyCoupon('${coupon.coupon_code}')" class="btn-primary px-3 py-1 text-sm">Apply</button>` : '<span class="text-gray-500 text-sm">Used</span>'}
                        </div>
                    `).join('')
                    : '<p class="text-gray-500 text-sm">No coupons available at the moment. üòü</p>';
            }
        } catch (error) {
            showAlert('error', 'Error', 'Failed to load coupons.', 2000);
        }
    }

    // Apply coupon
    async function applyCoupon(code = null) {
        const couponCode = code || (els.couponCode ? els.couponCode.value.trim() : '');
        if (!couponCode) {
            safeSetText(els.couponMessage, 'Please enter a coupon code.');
            safeToggleClass(els.couponMessage, 'hidden', false);
            return;
        }

        try {
            showLoading();
            const data = await apiCall('/checkout/apply-coupon', 'POST', { coupon_code: couponCode });
            closeLoading();

            if (data.status === 'ok') {
                state.appliedCoupon = true;
                state.appliedCouponCode = couponCode;
                state.couponDiscount = Number(data.coupon_discount) || 0;
                state.totalDiscount = Number(data.total_discount) || 0;
                state.finalTotal = Number(data.final_price) || 0;

                safeSetText(els.couponDiscount, `-$${state.couponDiscount.toFixed(2)}`);
                safeSetDisplay(els.couponDiscountRow, 'flex');
                safeSetText(els.finalTotal, `$${state.finalTotal.toFixed(2)}`);
                updateCouponUI(true, couponCode, state.couponDiscount);

                showAlert('success', 'Coupon Applied!', 'Coupon applied successfully!', 2000);
                await fetchCoupons();
            } else {
                safeSetText(els.couponMessage, data.message || 'Invalid coupon');
                safeToggleClass(els.couponMessage, 'hidden', false);
                showAlert('error', 'Coupon Failed', data.message || 'Failed to apply coupon', 2000);
            }
        } catch (error) {
            closeLoading();
            safeSetText(els.couponMessage, error.message || 'Failed to apply coupon');
            safeToggleClass(els.couponMessage, 'hidden', false);
            showAlert('error', 'Error', error.message || 'Failed to apply coupon', 2000);
        }
    }

    // Remove coupon
    async function removeCoupon() {
        try {
            showLoading();
            const data = await apiCall('/checkout/remove-coupon', 'POST');
            closeLoading();

            if (data.status === 'ok') {
                state.appliedCoupon = false;
                state.appliedCouponCode = "";
                state.couponDiscount = 0;
                state.totalDiscount = Number(data.total_discount) || state.offerDiscount;
                state.finalTotal = Number(data.final_price) || state.subtotal + state.shipping;

                safeSetDisplay(els.couponDiscountRow, 'none');
                safeSetText(els.couponDiscount, `-$${state.couponDiscount.toFixed(2)}`);
                safeSetText(els.finalTotal, `$${state.finalTotal.toFixed(2)}`);
                updateCouponUI(false);

                showAlert('success', 'Coupon Removed!', 'Coupon removed successfully!', 2000);
                await fetchCoupons();
            } else {
                showAlert('error', 'Error', data.message || 'Failed to remove coupon', 2000);
            }
        } catch (error) {
            closeLoading();
            showAlert('error', 'Error', error.message || 'Failed to remove coupon', 2000);
        }
    }

    // Select address
    async function selectAddress(id) {
        if (!id) {
            state.selectedAddressId = null;
            return;
        }
        state.selectedAddressId = parseInt(id, 10);
        try {
            showLoading();
            const data = await apiCall(`/profile/set-default-address/${state.selectedAddressId}`, 'POST');
            closeLoading();
            showAlert(data.status === 'ok' ? 'success' : 'error', data.status === 'ok' ? 'Address Selected' : 'Error', data.status === 'ok' ? 'This address is set for delivery.' : data.message || 'Failed to set address', 1500);
        } catch (error) {
            closeLoading();
            showAlert('error', 'Error', 'Could not connect to the server.', 2000);
        }
    }

    // Show address modal
    async function showAddressModal(addressId = null) {
        if (!els.addressModal) return;

        const isEdit = !!addressId;
        let formValues = {};
        if (isEdit) {
            try {
                showLoading();
                const response = await apiCall(`/profile/get-address/${addressId}`, 'GET');
                closeLoading();
                if (response.status !== 'ok') throw new Error(response.message || 'Failed to fetch address');
                formValues = response.address;
            } catch (error) {
                closeLoading();
                showAlert('error', 'Error', error.message || 'Could not connect to the server.', 2000);
                return;
            }
        }

        els.addressModal.classList.add('active');
        safeSetText(els.modalTitle, isEdit ? 'Edit Delivery Address' : 'Add New Address');

        const form = els.addressForm;
        if (form) {
            form.reset();
            form.dataset.editId = isEdit ? addressId : '';
            if (isEdit) {
                for (const [key, value] of Object.entries(formValues)) {
                    const field = form.elements[key.toLowerCase()];
                    if (field) field.value = value || '';
                }
            }
        }
    }

    // Close address modal
    function closeAddressModal(event) {
        if (event && event.target === els.addressModal || !event) {
            if (els.addressModal) els.addressModal.classList.remove('active');
        }
    }

    // Handle address form submission
    async function handleAddressSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const isEdit = !!form.dataset.editId;

        const payload = Object.fromEntries(formData);

        if (!/^\d{10}$/.test(payload.phone)) {
            showAlert('warning', 'Invalid Phone', 'Phone number must be exactly 10 digits.');
            return;
        }
        if (payload.alternate_phone && !/^\d{10}$/.test(payload.alternate_phone)) {
            showAlert('warning', 'Invalid Phone', 'Alternate phone number must be exactly 10 digits.');
            return;
        }

        try {
            showLoading();
            const url = isEdit ? `/profile/edit-address/${form.dataset.editId}` : '/profile/add-address';
            const data = await apiCall(url, 'POST', payload);
            closeLoading();

            if (data.status === 'ok') {
                showAlert('success', isEdit ? 'Address Updated!' : 'Address Added!', `Your address has been ${isEdit ? 'updated' : 'added'} successfully.`, 1500);
                setTimeout(() => window.location.reload(), 1600);
            } else {
                showAlert('error', 'Failed', data.message || 'Something went wrong', 2000);
            }
        } catch (error) {
            closeLoading();
            showAlert('error', 'Error', error.message || 'Could not connect to the server.', 2000);
        }
    }

    async function placeOrder() {
    console.log('=== PLACE ORDER DEBUG START ===');
    console.log('Selected address ID:', state.selectedAddressId);
    console.log('Address select value:', els.addressSelect?.value);

    if (!state.selectedAddressId || !els.addressSelect?.value) {
        console.log('‚ùå No address selected');
        showAlert('warning', 'No Address Selected', 'Please select a delivery address to proceed. üìç', 2000);
        return;
    }

    const paymentMethod = els.paymentMethod ? els.paymentMethod.value : 'COD';
    console.log('üí≥ Payment method selected:', paymentMethod);

    if (paymentMethod === 'WALLET' && state.walletBalance < state.finalTotal) {
        console.log('‚ùå Insufficient wallet balance:', state.walletBalance, '<', state.finalTotal);
        showAlert('error', 'Insufficient Wallet Balance', `Your wallet balance ($${state.walletBalance.toFixed(2)}) is less than the order amount ($${state.finalTotal.toFixed(2)}). Please add funds or choose another payment method.`, 3000);
        return;
    }

    try {
        showLoading();
        console.log('üöÄ Calling /checkout/place-order...');

        const requestPayload = {
            address_id: Number(state.selectedAddressId),
            payment_method: paymentMethod
        };
        console.log('üì§ Request payload:', requestPayload);

        const data = await apiCall('/checkout/place-order', 'POST', requestPayload);
        console.log('üì• Response from /checkout/place-order:', JSON.stringify(data, null, 2));
        closeLoading();

        // Check for error response with redirect
        if (data.status === 'error' && data.redirect) {
            console.log('‚ùå Error response with redirect:', data.redirect);
            showAlert('error', 'Order Error', data.message || 'Something went wrong with your order.', 2000);
            setTimeout(() => {
                console.log('üîÑ Redirecting to:', data.redirect);
                window.location.href = data.redirect;
            }, 2000);
            return;
        }

        // COD or WALLET Flow
        if (data.status === 'ok' && (paymentMethod === 'COD' || paymentMethod === 'WALLET')) {
            console.log('‚úÖ Order successful');
            showAlert('success', 'Order Placed!', 'Your order has been successfully placed. üéâ', 1500);
            setTimeout(() => {
                console.log('üîÑ Redirecting to success page:', data.redirect || `/order/success?order_id=${data.order_id}`);
                window.location.href = data.redirect || `/order/success?order_id=${data.order_id}`;
            }, 1600);
            return;
        }

        // Online Payment Flow
        if (data.status === 'payment_required' && paymentMethod === 'ONLINE') {
            console.log('üí∞ Payment required - initializing Razorpay...');
            console.log('Razorpay response fields:', {
                key_id: data.key_id,
                razorpay_order_id: data.razorpay_order_id,
                amount: data.amount,
                currency: data.currency,
                order_id: data.order_id,
                prefill: data.prefill,
                notes: data.notes
            });

            // Check if Razorpay SDK is loaded
            if (!window.Razorpay) {
                console.log('‚ùå Razorpay SDK not loaded');
                showAlert('error', 'Payment Error', 'Payment system is unavailable. Please try again later.', 3000);
                setTimeout(() => {
                    console.log('üîÑ Redirecting to failure page...');
                    window.location.href = `/order/failure?order_id=${data.order_id || 'unknown'}&error=${encodeURIComponent('Payment system unavailable')}`;
                }, 3000);
                return;
            }

            // Validate required Razorpay fields
            const requiredFields = ['key_id', 'razorpay_order_id', 'amount', 'currency'];
            const missingFields = requiredFields.filter(field => !data[field]);
            if (missingFields.length > 0) {
                console.log('‚ùå Missing required Razorpay fields:', missingFields);
                showAlert('error', 'Payment Error', `Invalid payment configuration: missing ${missingFields.join(', ')}. Please contact support.`, 3000);
                setTimeout(() => {
                    console.log('üîÑ Redirecting to failure page...');
                    window.location.href = `/order/failure?order_id=${data.order_id || 'unknown'}&error=${encodeURIComponent(`Missing fields: ${missingFields.join(', ')}`)}`;
                }, 3000);
                return;
            }

            // Ensure amount is a number
            if (typeof data.amount !== 'number' || isNaN(data.amount)) {
                console.log('‚ùå Invalid amount:', data.amount);
                showAlert('error', 'Payment Error', 'Invalid payment amount. Please contact support.', 3000);
                setTimeout(() => {
                    console.log('üîÑ Redirecting to failure page...');
                    window.location.href = `/order/failure?order_id=${data.order_id || 'unknown'}&error=${encodeURIComponent('Invalid payment amount')}`;
                }, 3000);
                return;
            }

            const razorpayOptions = {
                key: data.key_id,
                amount: data.amount,
                currency: data.currency,
                name: 'Silver E-commerce',
                description: `Order ID: ${data.order_id}`,
                order_id: data.razorpay_order_id,
                handler: (response) => {
                    console.log('üéâ Razorpay payment success!');
                    console.log('Razorpay response:', response);
                    console.log('Now calling verify payment...');
                    verifyPayment(response, data.order_id);
                },
                prefill: data.prefill || {
                    name: "{{.UserName}}",
                    email: "{{.UserEmail}}",
                    contact: "{{.UserPhone}}"
                },
                notes: data.notes || {},
                theme: { color: '#6b21a8' },
                modal: {
                    ondismiss: () => {
                        console.log('üíî Razorpay modal dismissed');
                        showAlert('warning', 'Payment Cancelled', 'Payment was cancelled by you. üòî', 2000);
                        setTimeout(() => {
                            console.log('üîÑ Redirecting to failure page...');
                            window.location.href = `/order/failure?order_id=${data.order_id || 'unknown'}&error=${encodeURIComponent('Payment cancelled by user')}`;
                        }, 2000);
                    }
                }
            };

            console.log('Razorpay options:', JSON.stringify(razorpayOptions, null, 2));
            try {
                const razorpayInstance = new Razorpay(razorpayOptions);
                razorpayInstance.on('payment.failed', (response) => {
                    console.log('üí• Razorpay payment failed:', response);
                    showAlert('error', 'Payment Failed', response.error.description || 'Payment failed due to an error.', 2000);
                    setTimeout(() => {
                        console.log('üîÑ Redirecting to failure page...');
                        window.location.href = `/order/failure?order_id=${data.order_id || 'unknown'}&error=${encodeURIComponent(response.error.description || 'Payment failed')}`;
                    }, 2000);
                });
                console.log('üöÄ Opening Razorpay modal...');
                razorpayInstance.open();
            } catch (error) {
                console.error('‚ùå Error initializing Razorpay:', error);
                showAlert('error', 'Payment Error', 'Failed to initialize payment. Please try again.', 3000);
                setTimeout(() => {
                    console.log('üîÑ Redirecting to failure page...');
                    window.location.href = `/order/failure?order_id=${data.order_id || 'unknown'}&error=${encodeURIComponent('Failed to initialize payment')}`;
                }, 3000);
            }
            return;
        }

        // Handle unexpected responses
        console.log('‚ö†Ô∏è Unexpected response:', JSON.stringify(data, null, 2));
        console.log('Status:', data.status);
        console.log('Payment method:', paymentMethod);

        showAlert('error', 'Order Error', data.message || 'Something went wrong with your order.', 2000);
        setTimeout(() => {
            console.log('üîÑ Redirecting to failure page...');
            window.location.href = `/order/failure?order_id=${data.order_id || 'unknown'}&error=${encodeURIComponent(data.message || 'Unexpected response')}`;
        }, 2000);

    } catch (error) {
        closeLoading();
        console.error('üí• Place order error:', error);
        showAlert('error', 'Connection Error', 'Could not connect to the server. Please check your internet connection. üåê', 3000);
        setTimeout(() => window.location.href = `/order/failure?order_id=unknown&error=${encodeURIComponent('Connection failed')}`, 3000);
    }

    console.log('=== PLACE ORDER DEBUG END ===');
}
    async function verifyPayment(razorpayResponse, internalOrderId) {
        console.log('=== VERIFY PAYMENT DEBUG START ===');
        console.log('üîç Verifying payment...');
        console.log('Razorpay response:', razorpayResponse);
        console.log('Internal order ID:', internalOrderId);

        try {
            showLoading();
            const payload = {
                razorpay_order_id: razorpayResponse.razorpay_order_id,
                razorpay_payment_id: razorpayResponse.razorpay_payment_id,
                razorpay_signature: razorpayResponse.razorpay_signature,
                order_id: internalOrderId
            };

            console.log('üì§ Verify payment payload:', payload);
            console.log('üöÄ Calling /checkout/verify-payment...');

            const data = await apiCall('/checkout/verify-payment', 'POST', payload);
            console.log('üì• Verify payment response:', data);
            closeLoading();

            if (data.status === 'ok') {
                console.log('‚úÖ Payment verification successful');
                showAlert('success', 'Payment Successful!', 'Your payment was processed successfully! üéâ', 1500);
                setTimeout(() => {
                    console.log('üîÑ Redirecting to success page:', data.redirect || `/order/success?order_id=${data.order_id || internalOrderId}`);
                    window.location.href = data.redirect || `/order/success?order_id=${data.order_id || internalOrderId}`;
                }, 1600);
            } else {
                console.log('‚ùå Payment verification failed:', data.message);
                showAlert('error', 'Payment Verification Failed', data.message || 'Payment verification failed', 2000);
                if (data.redirect) {
                    console.log('üîÑ Redirecting to:', data.redirect);
                    setTimeout(() => window.location.href = data.redirect, 2000);
                } else {
                    console.log('üîÑ Redirecting to failure page...');
                    setTimeout(() => window.location.href = `/order/failure?order_id=${internalOrderId}&error=${encodeURIComponent(data.message || 'Payment verification failed')}`, 2000);
                }
            }
        } catch (error) {
            console.error('üí• Verify payment error:', error);
            closeLoading();
            showAlert('error', 'Verification Error', error.message || 'Payment verification failed', 2000);
            setTimeout(() => window.location.href = `/order/failure?order_id=${internalOrderId}&error=${encodeURIComponent(error.message || 'Verification failed')}`, 2000);
        }

        console.log('=== VERIFY PAYMENT DEBUG END ===');
    }

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', () => {
        if (state.couponDiscount === 0 || !state.appliedCoupon) {
            safeSetDisplay(els.couponDiscountRow, 'none');
        } else {
            safeSetDisplay(els.couponDiscountRow, 'flex');
        }

        if (state.selectedAddressId && els.addressSelect) {
            els.addressSelect.value = state.selectedAddressId;
        }

        fetchCoupons();

        if (els.placeOrderBtn) {
            els.placeOrderBtn.addEventListener('click', placeOrder);
        }

        if (els.addressForm) {
            els.addressForm.addEventListener('submit', handleAddressSubmit);
        }
    });
</script>
</body>
</html>