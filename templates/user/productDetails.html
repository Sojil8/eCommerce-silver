<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Product.ProductName }} - Product Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        
        .img-zoom-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
        }
        .main-img {
            width: 100%;
            transition: transform 0.3s ease;
        }
        .img-zoom-box {
            position: absolute;
            width: 150px;
            height: 150px;
            border: 2px solid #ddd;
            background: white;
            display: none;
            overflow: hidden;
            pointer-events: none;
            z-index: 10;
        }
        .zoomed-img {
            position: absolute;
            max-width: none;
        }
        .img-zoom-container:hover .img-zoom-box {
            display: block;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .quantity-btn {
            width: 2rem;
            height: 2rem;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .quantity-btn:hover:not(:disabled) {
            background: #e5e7eb;
        }
        .quantity-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        .quantity-input {
            width: 2.5rem;
            height: 2rem;
            border: none;
            text-align: center;
            -moz-appearance: textfield;
        }
        .quantity-input:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }
        .variant-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .price-tag {
            position: relative;
            display: inline-block;
        }
        .offer-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .discount-pill {
            transform: rotate(-2deg);
            transition: all 0.3s ease;
        }
        .discount-pill:hover {
            transform: rotate(0deg) scale(1.05);
        }
        .offer-timer {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.025em;
        }
        .offer-container {
            transition: all 0.3s ease;
        }
        .offer-container:hover {
            transform: translateY(-2px);
        }
        .countdown-wrapper {
            display: inline-flex;
            align-items: center;
            font-family: 'Poppins', monospace;
            font-weight: 600;
            animation: fadeIn 0.5s ease-in;
        }
        .countdown-block {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 2.2rem;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            transition: all 0.3s ease;
        }
        .countdown-block small {
            font-size: 0.6rem;
            margin-left: 1px;
            opacity: 0.8;
        }
        .countdown-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .offer-container {
            transition: all 0.5s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .offer-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .animate-pulse {
            animation: urgentPulse 1.5s infinite;
        }
        @keyframes urgentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        @keyframes fadeIn {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .wishlist-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .wishlist-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .wishlist-btn.in-wishlist {
            color: #ef4444;
        }
        .wishlist-btn.in-wishlist i {
            color: #ef4444;
        }
        .wishlist-indicator {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
            border: 2px solid white;
            z-index: 1;
        }
        .wishlist-btn.in-wishlist .wishlist-indicator {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <!-- Navigation Bar -->
    {{template "navbar.html" .}}

    <!-- Breadcrumb -->
    <div class="container mx-auto px-4 py-4">
        {{ template "breadcrumbs.html" . }}
    </div>

    <!-- Product Detail Section -->
    <section class="py-8 bg-white">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Product Images -->
                <div>
                    <div class="img-zoom-container shadow-md relative">
                        {{ if gt (len .Product.Images) 0 }}
                        <img src="{{ index .Product.Images 0 }}" alt="{{ .Product.ProductName }}"
                            class="main-img hover:scale-105" id="main-image">
                        <div class="img-zoom-box">
                            <img src="{{ index .Product.Images 0 }}" alt="{{ .Product.ProductName }}"
                                class="zoomed-img" id="zoomed-image">
                        </div>
                        {{ if .Product.IsOffer }}
                        <div class="absolute top-3 left-3">
                            <div class="discount-pill bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">
                                {{ .Product.DiscountPercentage }}% OFF
                            </div>
                        </div>
                        {{ end }}
                        {{ if not .HasStock }}
                        <div class="absolute top-3 right-3 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs font-semibold px-3 py-1 rounded-full shadow-sm">
                            Out of Stock
                        </div>
                        {{ end }}
                        {{ else }}
                        <img src="/static/default-product.jpg" alt="Default Image"
                            class="main-img hover:scale-105" id="main-image">
                        <div class="img-zoom-box">
                            <img src="/static/default-product.jpg" alt="Default Image"
                                class="zoomed-img" id="zoomed-image">
                        </div>
                        {{ end }}
                    </div>
                    <div class="mt-3 flex space-x-2 overflow-x-auto">
                        {{ range .Product.Images }}
                        <img src="{{ . }}" alt="Thumbnail"
                            class="w-16 h-16 object-cover rounded-md cursor-pointer hover:ring-2 hover:ring-indigo-500 thumbnail"
                            data-src="{{ . }}">
                        {{ end }}
                    </div>
                </div>

                <!-- Product Info -->
                <div class="space-y-4">
                    <h1 class="text-2xl font-bold text-gray-900">{{ .Product.ProductName }}</h1>
                    
                    <!-- Brand Display -->
                    {{ if .Product.Brand }}
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-tag mr-2 text-indigo-500"></i>
                        <span>Brand: <strong class="text-gray-800">{{ .Product.Brand }}</strong></span>
                    </div>
                    {{ end }}

                    <!-- Price and Offer Display -->
                    <div class="price-tag">
                        {{ if .Product.IsOffer }}
                        <div class="offer-container bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200 mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl font-bold text-red-600" id="current-price">₹{{ printf "%.2f" .Product.OfferPrice }}</span>
                                <span class="line-through text-gray-400 text-base">₹{{ printf "%.2f" .Product.OriginalPrice }}</span>
                                <span class="offer-badge bg-red-100 text-red-600 text-xs font-semibold px-2 py-1 rounded-md">
                                    Save ₹{{ printf "%.2f" (sub .Product.OriginalPrice .Product.OfferPrice) }}
                                </span>
                            </div>
                            <p class="text-sm text-green-600 font-medium mt-1">{{ .Product.OfferName }}</p>
                            <div class="mt-2 flex items-center justify-between">
                                <div class="offer-timer text-indigo-600 flex items-center"
                                     {{ if not .Product.OfferEndTime.IsZero }}data-end-time="{{ .Product.OfferEndTime.Format "2006-01-02T15:04:05Z07:00" }}"{{ end }}>
                                    <i class="far fa-clock mr-1"></i>
                                    {{ if .Product.OfferEndTime.IsZero }}Limited time offer{{ else }}<span class="countdown-wrapper"><i class="far fa-clock mr-2"></i>Loading...</span>{{ end }}
                                </div>
                                <div id="days-remaining-badge" class="ml-2 hidden bg-indigo-100 text-indigo-800 text-xs font-semibold px-2 py-1 rounded-full"></div>
                            </div>
                        </div>
                        {{ else }}
                        <span class="text-2xl font-bold text-indigo-600" id="current-price">₹{{ printf "%.2f" .Product.Price }}</span>
                        {{ end }}
                    </div>

                    <!-- Description -->
                    <p class="text-gray-600">{{ .Product.Description }}</p>

                    <!-- Variants -->
                    {{ if .Product.Variants }}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Variant</label>
                        <div class="flex flex-wrap gap-2">
                            {{ range .Product.Variants }}
                            <button class="variant-btn px-3 py-1 bg-gray-100 rounded-md hover:bg-indigo-100 focus:ring-2 focus:ring-indigo-500"
                                data-variant-id="{{ .ID }}" data-color="{{ .Color }}"
                                data-offer-price="{{ if .IsOffer }}{{ .OfferPrice }}{{ else }}0{{ end }}"
                                data-original-price="{{ if .IsOffer }}{{ .OriginalPrice }}{{ else }}0{{ end }}"
                                data-price="{{ .ExtraPrice }}"
                                data-stock="{{ .Stock }}">
                                {{ .Color }}
                            </button>
                            {{ end }}
                        </div>
                    </div>
                    {{ end }}

                    <!-- Quantity -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                        <div class="quantity-control w-28">
                            <div class="quantity-btn" id="quantity-down"><i class="fas fa-minus text-gray-600"></i></div>
                            <input type="number" id="product-quantity" class="quantity-input" value="1" min="1"
                                {{ if .Product.Variants }}{{ with index .Product.Variants 0 }}max="{{ .Stock }}"{{ end }}{{ end }}>
                            <div class="quantity-btn" id="quantity-up"><i class="fas fa-plus text-gray-600"></i></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-3">
                        <button id="add-to-cart" data-product-id="{{ .Product.ID }}"
                            class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500">
                            Add to Cart
                        </button>
                        <button id="add-to-wishlist" data-product-id="{{ .Product.ID }}"
                            class="wishlist-btn bg-gray-200 text-gray-700 p-2 rounded-md hover:bg-gray-300 focus:ring-2 focus:ring-gray-400 relative {{if .Product.IsInWishlist}}in-wishlist{{end}}"
                            {{if .Product.IsInWishlist}}title="Remove from Wishlist"{{else}}title="Add to Wishlist"{{end}}>
                            <i class="{{if .Product.IsInWishlist}}fas{{else}}far{{end}} fa-heart wishlist-icon"></i>
                            <div class="wishlist-indicator"></div>
                        </button>
                    </div>

                    <!-- Stock Availability -->
                    <div class="text-gray-700">
                        <span class="font-medium">Availability:</span>
                        <span id="availability" class="text-green-600">In Stock (<span id="stock-quantity">
                            {{ if .Product.Variants }}{{ with index .Product.Variants 0 }}{{ .Stock }}{{ end }}{{ else }}0{{ end }}
                        </span>)</span>
                    </div>

                    {{ if .Product.IsOffer }}
                    <div class="mt-3 p-3 bg-indigo-50 rounded-md border border-indigo-100">
                        <div class="flex items-center">
                            <i class="fas fa-tag text-indigo-500 mr-2"></i>
                            <p class="text-sm text-indigo-700">This offer is valid for a limited time only. Don't miss out!</p>
                        </div>
                    </div>
                    {{ end }}
                </div>
            </div>
        </div>
    </section>

    <!-- Related Products Section -->
    <section class="py-8 bg-gray-50">
        <div class="container mx-auto px-4">
            <h2 class="text-xl font-bold text-gray-900 text-center mb-8">Related Products</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                {{ range .RelatedProducts }}
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-all group relative">
                    {{ if gt (len .Images) 0 }}
                    <img src="{{ index .Images 0 }}" alt="{{ .ProductName }}"
                        class="w-full h-48 object-cover group-hover:scale-105 transition-transform rounded-t-lg">
                    {{ else }}
                    <img src="/static/default-product.jpg" alt="{{ .ProductName }}"
                        class="w-full h-48 object-cover group-hover:scale-105 transition-transform rounded-t-lg">
                    {{ end }}
                    {{ if .IsOffer }}
                    <div class="absolute top-3 left-3">
                        <div class="discount-pill bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">
                            {{ .DiscountPercentage }}% OFF
                        </div>
                    </div>
                    {{ end }}
                    <div class="p-3">
                        <a href="/product/details/{{ .ID }}"
                            class="block text-gray-900 font-semibold hover:text-indigo-600">{{ .ProductName }}</a>
                        {{ if .Brand }}
                        <p class="text-xs text-gray-500 mb-2">{{ .Brand }}</p>
                        {{ end }}
                        <div class="flex justify-between items-center mt-2">
                            <div>
                                {{ if .IsOffer }}
                                <span class="text-lg font-bold text-red-600">₹{{ printf "%.2f" .OfferPrice }}</span>
                                <span class="line-through text-gray-400 text-sm ml-2">₹{{ printf "%.2f" .OriginalPrice }}</span>
                                <span class="offer-badge bg-red-100 text-red-600 text-xs font-semibold px-2 py-1 rounded-md ml-2">
                                    Save ₹{{ printf "%.2f" (sub .OriginalPrice .OfferPrice) }}
                                </span>
                                {{ else }}
                                <span class="text-lg font-bold text-indigo-600">₹{{ printf "%.2f" .OfferPrice }}</span>
                                {{ end }}
                            </div>
                            {{ if .IsOffer }}
                            <div class="mt-1 text-indigo-600 text-xs offer-timer"
                                 {{ if not .OfferEndTime.IsZero }}data-end-time="{{ .OfferEndTime.Format "2006-01-02T15:04:05Z07:00" }}"{{ end }}>
                                {{ if .OfferEndTime.IsZero }}
                                <i class="far fa-clock mr-1"></i>Limited time offer
                                {{ else }}
                                <span class="countdown-wrapper"><i class="far fa-clock mr-2"></i>Loading...</span>
                                {{ end }}
                            </div>
                            {{ end }}
                            <button class="wishlist-btn text-gray-500 hover:text-red-500 relative {{if .IsInWishlist}}in-wishlist{{end}}"
                                data-product-id="{{ .ID }}" title="{{if .IsInWishlist}}Remove from Wishlist{{else}}Add to Wishlist{{end}}">
                                <i class="{{if .IsInWishlist}}fas{{else}}far{{end}} fa-heart wishlist-icon"></i>
                                <div class="wishlist-indicator"></div>
                            </button>
                        </div>
                    </div>
                </div>
                {{ else }}
                <p class="text-center text-gray-600 col-span-full">No related products available.</p>
                {{ end }}
            </div>
        </div>
    </section>

    <br>
    <br>
    <section class="mb-12">
      <h2 class="text-4xl font-semibold text-gray-800 mb-8 text-center tracking-wide">Shop by Brand</h2>
      <div class="container mx-auto px-4 flex justify-center">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
          <a href="/shop?brand=Rolex" class="brand-card bg-white rounded-xl shadow-md hover:shadow-lg transition-all max-w-xs p-4">
            <img src="/static/images/brands/rollex.jpg" alt="Rolex" class="w-full h-48 object-contain rounded-t-xl">
            <div class="p-4 text-center">
              <h3 class="text-lg font-semibold text-gray-800">Rolex</h3>
              <p class="text-sm text-gray-500">Iconic luxury and precision</p>
            </div>
          </a>
          <a href="/shop?brand=Omega" class="brand-card bg-white rounded-xl shadow-md hover:shadow-lg transition-all max-w-xs p-4">
            <img src="/static/images/brands/Omega" alt="Omega" class="w-full h-48 object-contain rounded-t-xl">
            <div class="p-4 text-center">
              <h3 class="text-lg font-semibold text-gray-800">Omega</h3>
              <p class="text-sm text-gray-500">Heritage and innovation</p>
            </div>
          </a>
          <a href="/shop?brand=Seven+Friday" class="brand-card bg-white rounded-xl shadow-md hover:shadow-lg transition-all max-w-xs p-4">
            <img src="/static/images/brands/SevenFriday.png" alt="Seven Friday" class="w-full h-48 object-contain rounded-t-xl">
            <div class="p-4 text-center">
              <h3 class="text-lg font-semibold text-gray-800">Seven Friday</h3>
              <p class="text-sm text-gray-500">Sporty elegance and performance</p>
            </div>
          </a>
          <a href="/shop?brand=Casio" class="brand-card bg-white rounded-xl shadow-md hover:shadow-lg transition-all max-w-xs p-4">
            <img src="/static/images/brands/Casio.png" alt="Casio" class="w-full h-48 object-contain rounded-t-xl">
            <div class="p-4 text-center">
              <h3 class="text-lg font-semibold text-gray-800">Casio</h3>
              <p class="text-sm text-gray-500">Reliable and versatile timepieces</p>
            </div>
          </a>
        </div>
      </div>
    </section>

    <footer class="bg-gradient-to-r from-indigo-800 to-purple-900 text-white py-8 mt-auto">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <p class="text-sm">© 2025 Silver Shop. All rights reserved.</p>
          <div class="mt-4 md:mt-0 space-x-6">
            <a href="#" class="text-gray-200 hover:text-yellow-300 transition-color duration-200">Privacy Policy</a>
            <a href="#" class="text-gray-200 hover:text-yellow-300 transition-color duration-200">Terms of Service</a>
          </div>
        </div>
      </div>
    </footer>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
    const mainImage = document.getElementById('main-image');
    const zoomedImage = document.getElementById('zoomed-image');
    const zoomBox = document.querySelector('.img-zoom-box');
    const thumbnails = document.querySelectorAll('.thumbnail');
    const quantityInput = document.getElementById('product-quantity');
    const btnQuantityUp = document.getElementById('quantity-up');
    const btnQuantityDown = document.getElementById('quantity-down');
    const addToCartBtn = document.getElementById('add-to-cart');
    const variantButtons = document.querySelectorAll('.variant-btn');
    const currentPriceEl = document.getElementById('current-price');
    const stockQuantityEl = document.getElementById('stock-quantity');
    const availabilityEl = document.getElementById('availability');
    const imgZoomContainer = document.querySelector('.img-zoom-container');

    let selectedVariant = null;
    let isWishlistProcessing = false;

    // Wishlist toggle function
    async function toggleWishlist(productId, button) {
        if (isWishlistProcessing) return;
        isWishlistProcessing = true;

        const variantId = document.querySelector('.variant-btn.active')?.getAttribute('data-variant-id');
        const wasInWishlist = button.classList.contains('in-wishlist');

        try {
            const response = await fetch(`/wishlist/add/${productId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ variant_id: variantId }),
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            console.log('Wishlist response:', data); // Debug log
            
            // Determine if the item is now in the wishlist based on the response
            let isInWishlist;
            if (data.status === 'REMOVED' || data.message?.toLowerCase().includes('removed')) {
                isInWishlist = false;
            } else if (data.status === 'ADDED' || data.status === 'OK' || data.status === 'success' || data.message?.toLowerCase().includes('added')) {
                isInWishlist = true;
            } else {
                // Fallback: toggle from current state
                isInWishlist = !wasInWishlist;
            }

            // Update all buttons for this product
            document.querySelectorAll(`button[data-product-id="${productId}"]`).forEach(btn => {
                const icon = btn.querySelector('.wishlist-icon');
                const indicator = btn.querySelector('.wishlist-indicator');

                if (icon) {
                    if (isInWishlist) {
                        btn.classList.add('in-wishlist');
                        icon.className = 'fas fa-heart wishlist-icon';
                        btn.title = 'Remove from Wishlist';
                        if (indicator) {
                            indicator.style.opacity = '1';
                            indicator.style.transform = 'scale(1)';
                        }
                    } else {
                        btn.classList.remove('in-wishlist');
                        icon.className = 'far fa-heart wishlist-icon';
                        btn.title = 'Add to Wishlist';
                        if (indicator) {
                            indicator.style.opacity = '0';
                            indicator.style.transform = 'scale(0)';
                        }
                    }
                }
            });

            // Show correct message based on the action
            const message = isInWishlist ? 'Added to Wishlist!' : 'Removed from Wishlist!';
            Swal.fire({
                title: message,
                icon: isInWishlist ? 'success' : 'info',
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        } catch (error) {
            console.error('Wishlist error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Failed to update wishlist',
                icon: 'error',
                timer: 2000
            });
        } finally {
            isWishlistProcessing = false;
        }
    }

    // Initialize wishlist buttons with click handlers
    const mainWishlistBtn = document.getElementById('add-to-wishlist');
    if (mainWishlistBtn && mainWishlistBtn.querySelector('.wishlist-icon')) {
        mainWishlistBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const productId = e.currentTarget.getAttribute('data-product-id');
            toggleWishlist(productId, e.currentTarget);
        });
    }

    document.querySelectorAll('.wishlist-btn').forEach(btn => {
        if (btn.querySelector('.wishlist-icon')) {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const productId = btn.getAttribute('data-product-id');
                toggleWishlist(productId, btn);
            });
        }
    });

    // Update price display
    function updatePriceDisplay(offerPrice, originalPrice, isOffer, extraPrice) {
        let newPrice;
        if (isOffer) {
            newPrice = offerPrice;
            if (currentPriceEl) {
                currentPriceEl.textContent = `₹${newPrice.toFixed(2)}`;
            }
            const originalPriceEl = document.querySelector('.line-through');
            if (originalPriceEl) {
                originalPriceEl.textContent = `₹${originalPrice.toFixed(2)}`;
            }
            const savingsEl = document.querySelector('.offer-badge');
            if (savingsEl && savingsEl.textContent.includes('Save')) {
                const savings = originalPrice - offerPrice;
                savingsEl.textContent = `Save ₹${savings.toFixed(2)}`;
            }
        } else {
            newPrice = parseFloat({{ .Product.Price }}) + extraPrice;
            if (currentPriceEl) {
                currentPriceEl.textContent = `₹${newPrice.toFixed(2)}`;
            }
        }
    }

    // Timer logic for main and related products
    document.querySelectorAll('.offer-timer').forEach(timer => {
        const endTimeStr = timer.getAttribute('data-end-time');
        if (!endTimeStr) {
            timer.innerHTML = '<i class="far fa-clock mr-1"></i>Limited time offer';
            return;
        }
        const endTime = new Date(endTimeStr);
        if (isNaN(endTime.getTime())) {
            timer.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>Invalid offer time';
            console.error('Invalid end time format:', endTimeStr);
            return;
        }
        function updateTimer() {
            const now = new Date();
            const diff = endTime - now;
            if (diff <= 0) {
                timer.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>Offer ended';
                const badge = timer.parentElement.querySelector('#days-remaining-badge');
                if (badge) {
                    badge.textContent = 'Offer ended';
                    badge.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'animate-pulse', 'bg-orange-100', 'text-orange-800', 'bg-green-100', 'text-green-800');
                    badge.classList.add('bg-gray-100', 'text-gray-800');
                }
                const container = timer.closest('.offer-container');
                if (container) container.classList.add('bg-gray-100', 'border-gray-200');
                return;
            }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const formattedDays = String(days).padStart(2, '0');
            const formattedHours = String(hours).padStart(2, '0');
            const formattedMinutes = String(minutes).padStart(2, '0');
            const timerHTML = `
                <span class="countdown-wrapper">
                    <i class="far fa-clock mr-2"></i>
                    <span class="countdown-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded">${formattedDays}<small>d</small></span>
                    <span class="mx-1">:</span>
                    <span class="countdown-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded">${formattedHours}<small>h</small></span>
                    <span class="mx-1">:</span>
                    <span class="countdown-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded">${formattedMinutes}<small>m</small></span>
                </span>
            `;
            timer.innerHTML = timerHTML;
            const badge = timer.parentElement.querySelector('#days-remaining-badge');
            if (badge) {
                if (days > 0) {
                    badge.textContent = days === 1 ? '1 day left' : `${days} days left`;
                    badge.classList.remove('hidden', 'bg-gray-100', 'text-gray-800');
                    if (days <= 1) {
                        badge.classList.add('bg-red-100', 'text-red-800', 'animate-pulse');
                    } else if (days <= 3) {
                        badge.classList.add('bg-orange-100', 'text-orange-800');
                    } else {
                        badge.classList.add('bg-green-100', 'text-green-800');
                    }
                } else {
                    badge.classList.add('hidden');
                }
            }
            const container = timer.closest('.offer-container');
            if (container) {
                container.className = 'offer-container p-3 rounded-lg border mb-3';
                if (days <= 0 && hours < 24) {
                    container.classList.add('bg-gradient-to-r', 'from-red-50', 'to-pink-50', 'border-red-200', 'animate-pulse');
                } else if (days <= 3) {
                    container.classList.add('bg-gradient-to-r', 'from-orange-50', 'to-yellow-50', 'border-orange-200');
                } else {
                    container.classList.add('bg-gradient-to-r', 'from-green-50', 'to-emerald-50', 'border-green-200');
                }
            }
            setTimeout(updateTimer, 1000);
        }
        updateTimer();
    });

    // Image zoom
    if (mainImage && zoomedImage && zoomBox && imgZoomContainer) {
        const zoomRatio = 2.5;
        imgZoomContainer.addEventListener('mousemove', e => {
            const rect = mainImage.getBoundingClientRect();
            const cursorX = e.clientX - rect.left;
            const cursorY = e.clientY - rect.top;
            const boxHalf = zoomBox.offsetWidth / 2;
            const boxX = Math.max(0, Math.min(cursorX - boxHalf, rect.width - zoomBox.offsetWidth));
            const boxY = Math.max(0, Math.min(cursorY - boxHalf, rect.height - zoomBox.offsetHeight));
            zoomBox.style.left = `${boxX}px`;
            zoomBox.style.top = `${boxY}px`;
            const zoomPosX = (cursorX / rect.width) * 100;
            const zoomPosY = (cursorY / rect.height) * 100;
            zoomedImage.style.width = `${rect.width * zoomRatio}px`;
            zoomedImage.style.height = `${rect.height * zoomRatio}px`;
            zoomedImage.style.transform = `translate(-${zoomPosX}%, -${zoomPosY}%)`;
        });
        imgZoomContainer.addEventListener('mouseenter', () => zoomBox.style.display = 'block');
        imgZoomContainer.addEventListener('mouseleave', () => zoomBox.style.display = 'none');
    }

    // Thumbnails
    thumbnails.forEach(thumb => {
        thumb.addEventListener('click', () => {
            const newSrc = thumb.getAttribute('data-src');
            thumbnails.forEach(t => t.classList.remove('ring-2', 'ring-indigo-500'));
            thumb.classList.add('ring-2', 'ring-indigo-500');
            mainImage.src = newSrc;
            zoomedImage.src = newSrc;
        });
    });
    thumbnails[0]?.classList.add('ring-2', 'ring-indigo-500');

    // Update stock display
    function updateStockDisplay(stock) {
        if (stockQuantityEl) stockQuantityEl.textContent = stock;
        if (stock > 0) {
            if (availabilityEl) {
                availabilityEl.innerHTML = `In Stock (<span id="stock-quantity">${stock}</span>)`;
                availabilityEl.classList.remove('text-red-600');
                availabilityEl.classList.add('text-green-600');
            }
            if (addToCartBtn) {
                addToCartBtn.disabled = false;
                addToCartBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                addToCartBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
            if (btnQuantityUp) btnQuantityUp.disabled = false;
            if (btnQuantityDown) btnQuantityDown.disabled = false;
            if (quantityInput) {
                quantityInput.disabled = false;
                quantityInput.max = stock;
                if (parseInt(quantityInput.value) > stock) quantityInput.value = stock;
            }
        } else {
            if (availabilityEl) {
                availabilityEl.innerHTML = 'Out of Stock';
                availabilityEl.classList.remove('text-green-600');
                availabilityEl.classList.add('text-red-600');
            }
            if (addToCartBtn) {
                addToCartBtn.disabled = true;
                addToCartBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                addToCartBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            }
            if (btnQuantityUp) btnQuantityUp.disabled = true;
            if (btnQuantityDown) btnQuantityDown.disabled = true;
            if (quantityInput) quantityInput.disabled = true;
        }
    }

    // Variants
    if (variantButtons.length) {
        variantButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                variantButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedVariant = {
                    id: parseInt(btn.getAttribute('data-variant-id'), 10),
                    offerPrice: parseFloat(btn.getAttribute('data-offer-price')) || 0,
                    originalPrice: parseFloat(btn.getAttribute('data-original-price')) || 0,
                    price: parseFloat(btn.getAttribute('data-price')),
                    stock: parseInt(btn.getAttribute('data-stock')),
                    isOffer: btn.getAttribute('data-offer-price') > 0
                };
                updatePriceDisplay(
                    selectedVariant.isOffer ? selectedVariant.offerPrice : selectedVariant.price,
                    selectedVariant.isOffer ? selectedVariant.originalPrice : selectedVariant.price,
                    selectedVariant.isOffer,
                    selectedVariant.isOffer ? 0 : parseFloat(btn.getAttribute('data-price'))
                );
                updateStockDisplay(selectedVariant.stock);
            });
        });
        variantButtons[0].click();
    } else {
        if (addToCartBtn) {
            addToCartBtn.disabled = true;
            addToCartBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        }
        updateStockDisplay(0);
    }

    // Quantity controls
    if (btnQuantityUp) {
        btnQuantityUp.addEventListener('click', () => {
            if (!selectedVariant) return;
            let value = parseInt(quantityInput.value, 10);
            if (value < selectedVariant.stock) {
                quantityInput.value = value + 1;
            } else {
                Swal.fire({ title: "Out Of Stock", text: "Can't Add Item Quantity.", icon: "info", timer: 2000 });
            }
        });
    }

    if (btnQuantityDown) {
        btnQuantityDown.addEventListener('click', () => {
            if (!selectedVariant) return;
            let value = parseInt(quantityInput.value, 10);
            if (value > 1) quantityInput.value = value - 1;
        });
    }

    if (quantityInput) {
        quantityInput.addEventListener('input', () => {
            if (!selectedVariant) return;
            let value = parseInt(quantityInput.value, 10);
            if (isNaN(value) || value < 1) {
                quantityInput.value = 1;
            } else if (value > selectedVariant.stock) {
                quantityInput.value = selectedVariant.stock;
                Swal.fire({ title: "Max Quantity", text: "Cannot add more than stock.", icon: "info", timer: 2000 });
            }
        });
    }

    // Add to cart
    if (addToCartBtn) {
        addToCartBtn.addEventListener('click', async () => {
            if (!selectedVariant) {
                Swal.fire({ title: "Select a Variant", text: "Please select a variant.", icon: "warning", timer: 2000 });
                return;
            }
            const productId = parseInt(addToCartBtn.getAttribute('data-product-id'), 10);
            const quantity = parseInt(quantityInput.value, 10);
            const variantId = selectedVariant.id;
            try {
                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId, quantity, variant_id: variantId }),
                    credentials: 'include'
                });
                const data = await response.json();
                if (response.ok) {
                    Swal.fire({ title: "Added to Cart", text: data.message || "Item added", icon: "success", timer: 1500 });
                } else {
                    Swal.fire({ title: "Error", text: data.error || "Failed to add to cart", icon: "error", timer: 2000 });
                    if (data.redirect) setTimeout(() => window.location.href = data.redirect, 2000);
                }
            } catch {
                Swal.fire({ title: "Error", text: "Failed to add to cart.", icon: "error", timer: 2000 });
            }
        });
    }
});
    </script>
</body>
</html>