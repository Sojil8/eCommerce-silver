<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center p-4">
    <div class="relative bg-gray-950 p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-sm sm:max-w-md md:max-w-lg z-10 border border-gray-700">
        <h1 class="text-2xl sm:text-3xl font-bold text-white mb-6 text-center">Admin Login</h1>
        <form id="adminLoginForm" class="space-y-6">
            <input 
                type="email" 
                name="email" 
                id="email" 
                class="w-full px-4 py-3 bg-gray-900 border border-gray-600 text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none placeholder-gray-400 text-sm sm:text-base" 
                placeholder="Enter your email" 
                required
            >
            <input 
                type="password" 
                name="password" 
                id="password" 
                class="w-full px-4 py-3 bg-gray-900 border border-gray-600 text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none placeholder-gray-400 text-sm sm:text-base" 
                placeholder="Enter your password" 
                required
            >
            <div id="error" class="text-red-400 text-xs sm:text-sm hidden"></div>
            <button 
                type="submit" 
                class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 transition duration-300 text-sm sm:text-base"
            >
                Login
            </button>
        </form>
    </div>

    <script>
    // Function to get cookie by name
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // Check if already logged in
    async function checkAuth() {
        const token = getCookie('jwtTokensAdmin');
        if (token) {
            try {
                const response = await fetch('/admin/dashboard', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    window.location.replace('/admin/dashboard');
                }
            } catch (error) {
                console.error('Auth check error:', error);
                document.cookie = 'jwtTokensAdmin=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            }
        }
    }

    // Handle form submission
    document.getElementById('adminLoginForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorElement = document.getElementById('error');
        const submitButton = event.target.querySelector('button[type="submit"]');

        errorElement.style.display = 'none';
        submitButton.disabled = true;
        submitButton.textContent = 'Logging in...';

        const data = { email, password };

        try {
            const response = await fetch('/admin/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            if (response.redirected) {
                window.location.replace(response.url);
                return;
            }

            const result = await response.json();

            if (!response.ok) {
                errorElement.textContent = result.message || 'Login failed';
                errorElement.style.display = 'block';
                return;
            }

            // Login successful
            console.log("Login successful:", result);
            window.location.replace('/admin/dashboard');

        } catch (error) {
            errorElement.textContent = 'An error occurred. Please try again.';
            errorElement.style.display = 'block';
            console.error('Login error:', error);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Login';
        }
    });

    // Prevent back navigation to cached login page
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) window.location.reload();
    });

    // Initialize
    window.addEventListener('load', function() {
        checkAuth();
        if (window.history.replaceState) window.history.replaceState(null, null, window.location.href);
    });
    </script>

    <style>
        /* Remove blob animation for cleaner design */
        .animate-blob {
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .max-w-sm {
                max-width: 100%;
            }
            h1 {
                font-size: 1.5rem;
            }
            input, button {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
        }
    </style>
</body>
</html>