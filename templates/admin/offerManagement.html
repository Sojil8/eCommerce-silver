<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offer Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6 text-center">Offer Management</h1>

        <!-- Product Offers Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Product Offers</h2>
            <div class="overflow-x-auto">
                <table class="w-full bg-white shadow-md rounded-lg">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700">
                            <th class="py-3 px-4 text-left">ID</th>
                            <th class="py-3 px-4 text-left">Product Name</th>
                            <th class="py-3 px-4 text-left">Discount (%)</th>
                            <th class="py-3 px-4 text-left">Start Date</th>
                            <th class="py-3 px-4 text-left">End Date</th>
                            <th class="py-3 px-4 text-left">Active</th>
                            <th class="py-3 px-4 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .ProductOffers}}
                        <tr class="border-b">
                            <td class="py-3 px-4">{{.ID}}</td>
                            <td class="py-3 px-4">{{.ProductName}}</td>
                            <td class="py-3 px-4">{{.Discount}}</td>
                            <td class="py-3 px-4">{{.StartDate.Format "2006-01-02"}}</td>
                            <td class="py-3 px-4">{{.EndDate.Format "2006-01-02"}}</td>
                            <td class="py-3 px-4">{{if .IsActive}}Yes{{else}}No{{end}}</td>
                            <td class="py-3 px-4">
                                <button onclick="showEditOfferModal('product', {{.ID}})" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button>
                                <button onclick="deleteProductOffer({{.ID}})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Delete</button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Category Offers Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Category Offers</h2>
            <div class="overflow-x-auto">
                <table class="w-full bg-white shadow-md rounded-lg">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700">
                            <th class="py-3 px-4 text-left">ID</th>
                            <th class="py-3 px-4 text-left">Category Name</th>
                            <th class="py-3 px-4 text-left">Discount (%)</th>
                            <th class="py-3 px-4 text-left">Start Date</th>
                            <th class="py-3 px-4 text-left">End Date</th>
                            <th class="py-3 px-4 text-left">Active</th>
                            <th class="py-3 px-4 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .CategoryOffers}}
                        <tr class="border-b">
                            <td class="py-3 px-4">{{.ID}}</td>
                            <td class="py-3 px-4">{{.CategoryName}}</td>
                            <td class="py-3 px-4">{{.Discount}}</td>
                            <td class="py-3 px-4">{{.StartDate.Format "2006-01-02"}}</td>
                            <td class="py-3 px-4">{{.EndDate.Format "2006-01-02"}}</td>
                            <td class="py-3 px-4">{{if .IsActive}}Yes{{else}}No{{end}}</td>
                            <td class="py-3 px-4">
                                <button onclick="showEditOfferModal('category', {{.ID}})" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button>
                                <button onclick="deleteCategoryOffer({{.ID}})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Delete</button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add Offer Button -->
        <div class="mt-4">
            <button onclick="showAddOfferModal()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add New Offer</button>
        </div>

        <!-- Add Offer Modal -->
        <div id="addOfferModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md">
                <h3 class="text-xl font-semibold mb-4">Add Offer</h3>
                <div class="grid grid-cols-1 gap-4">
                    <!-- Offer Type Selection -->
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="offer_type" value="product" class="mr-2" checked onchange="updateSelection()">
                            <span>Product Offer</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="offer_type" value="category" class="mr-2" onchange="updateSelection()">
                            <span>Category Offer</span>
                        </label>
                    </div>
                    <!-- Dynamic Dropdown -->
                    <select id="item_select" class="border p-2 rounded">
                        <!-- Options populated by JavaScript -->
                    </select>
                    <input type="number" id="discount" placeholder="Discount (%)" step="0.01" class="border p-2 rounded">
                    <input type="date" id="start_date" class="border p-2 rounded">
                    <input type="date" id="end_date" class="border p-2 rounded">
                    <label class="flex items-center">
                        <input type="checkbox" id="is_active" class="mr-2">
                        <span>Is Active</span>
                    </label>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideAddOfferModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                        <button onclick="addOffer()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add Offer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Offer Modal -->
        <div id="editOfferModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md">
                <h3 class="text-xl font-semibold mb-4">Edit Offer</h3>
                <div class="grid grid-cols-1 gap-4">
                    <input type="hidden" id="edit_offer_id">
                    <input type="hidden" id="edit_offer_type">
                    <input type="number" id="edit_discount" placeholder="Discount (%)" step="0.01" class="border p-2 rounded">
                    <input type="date" id="edit_start_date" class="border p-2 rounded">
                    <input type="date" id="edit_end_date" class="border p-2 rounded">
                    <label class="flex items-center">
                        <input type="checkbox" id="edit_is_active" class="mr-2">
                        <span>Is Active</span>
                    </label>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideEditOfferModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                        <button onclick="updateOffer()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Update Offer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store products and categories from Go template
        const products = [
            {{range .Products}}
                { id: {{.ID}}, name: "{{.ProductName}}" },
            {{end}}
        ];
        const categories = [
            {{range .Categories}}
                { id: {{.ID}}, name: "{{.CategoryName}}" },
            {{end}}
        ];

        // Function to show the add modal
        function showAddOfferModal() {
            document.getElementById('addOfferModal').classList.remove('hidden');
            updateSelection();
        }

        // Function to hide the add modal
        function hideAddOfferModal() {
            document.getElementById('addOfferModal').classList.add('hidden');
            // Clear form inputs
            document.getElementById('item_select').value = '';
            document.getElementById('discount').value = '';
            document.getElementById('start_date').value = '';
            document.getElementById('end_date').value = '';
            document.getElementById('is_active').checked = false;
        }

        // Function to update the dropdown based on offer type
        function updateSelection() {
            const offerType = document.querySelector('input[name="offer_type"]:checked').value;
            const select = document.getElementById('item_select');
            select.innerHTML = '<option value="">Select...</option>';

            const items = offerType === 'product' ? products : categories;
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                select.appendChild(option);
            });
        }

        // Initialize dropdown on page load
        document.addEventListener('DOMContentLoaded', updateSelection);

        // Add offer function
        async function addOffer() {
            const offerType = document.querySelector('input[name="offer_type"]:checked').value;
            const itemId = document.getElementById('item_select').value;
            const discount = document.getElementById('discount').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const isActive = document.getElementById('is_active').checked;

            if (!itemId) {
                alert('Please select a product or category');
                return;
            }

            const endpoint = offerType === 'product' ? `/admin/product_offers/${itemId}` : `/admin/category_offers/${itemId}`;
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    discount: parseFloat(discount),
                    start_date: new Date(startDate).toISOString(),
                    end_date: new Date(endDate).toISOString(),
                    is_active: isActive
                })
            });

            const result = await response.json();
            alert(result.message || result.error);
            if (response.ok) {
                hideAddOfferModal();
                location.reload();
            }
        }

        // Show edit offer modal
        async function showEditOfferModal(type, id) {
            const endpoint = type === 'product' ? `/admin/product_offers/${id}` : `/admin/category_offers/${id}`;
            const response = await fetch(endpoint);
            const data = await response.json();
            if (!response.ok) {
                alert(data.error);
                return;
            }

            // Populate modal fields
            document.getElementById('edit_offer_id').value = id;
            document.getElementById('edit_offer_type').value = type;
            document.getElementById('edit_discount').value = data.offer.discount;
            document.getElementById('edit_start_date').value = data.offer.start_date.split('T')[0];
            document.getElementById('edit_end_date').value = data.offer.end_date.split('T')[0];
            document.getElementById('edit_is_active').checked = data.offer.is_active;

            // Show modal
            document.getElementById('editOfferModal').classList.remove('hidden');
        }

        // Hide edit offer modal
        function hideEditOfferModal() {
            document.getElementById('editOfferModal').classList.add('hidden');
            // Clear form inputs
            document.getElementById('edit_offer_id').value = '';
            document.getElementById('edit_offer_type').value = '';
            document.getElementById('edit_discount').value = '';
            document.getElementById('edit_start_date').value = '';
            document.getElementById('edit_end_date').value = '';
            document.getElementById('edit_is_active').checked = false;
        }

        // Update offer function
        async function updateOffer() {
            const id = document.getElementById('edit_offer_id').value;
            const type = document.getElementById('edit_offer_type').value;
            const discount = document.getElementById('edit_discount').value;
            const startDate = document.getElementById('edit_start_date').value;
            const endDate = document.getElementById('edit_end_date').value;
            const isActive = document.getElementById('edit_is_active').checked;

            const endpoint = type === 'product' ? `/admin/product_offers/${id}` : `/admin/category_offers/${id}`;
            const response = await fetch(endpoint, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    discount: parseFloat(discount),
                    start_date: new Date(startDate).toISOString(),
                    end_date: new Date(endDate).toISOString(),
                    is_active: isActive
                })
            });

            const result = await response.json();
            alert(result.message || result.error);
            if (response.ok) {
                hideEditOfferModal();
                location.reload();
            }
        }

        // Delete product offer
        async function deleteProductOffer(id) {
            if (confirm('Are you sure you want to delete this offer?')) {
                const response = await fetch(`/admin/product_offers/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                alert(result.message || result.error);
                if (response.ok) location.reload();
            }
        }

        // Delete category offer
        async function deleteCategoryOffer(id) {
            if (confirm('Are you sure you want to delete this offer?')) {
                const response = await fetch(`/admin/category_offers/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                alert(result.message || result.error);
                if (response.ok) location.reload();
            }
        }

        // Apply best offer
        async function applyBestOffer(productId) {
            const response = await fetch(`/admin/apply_offer/${productId}`);
            const result = await response.json();
            if (response.ok) {
                const product = result.product;
                alert(`Product: ${product.product_name}\nOriginal Price: $${product.original_price}\nDiscounted Price: $${product.discounted_price}\nDiscount Applied: ${product.applied_discount}% (${product.offer_type} offer)`);
            } else {
                alert(result.error);
            }
        }
    </script>
</body>
</html>