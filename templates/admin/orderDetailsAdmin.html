<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Orders | E-Commerce Silver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .order-item {
            transition: all 0.3s ease;
        }
        .order-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-pending {
            background-color: #FEF3C7;
            color: #92400E;
        }
        .badge-confirmed {
            background-color: #DBEAFE;
            color: #1E40AF;
        }
        .badge-shipped {
            background-color: #E0E7FF;
            color: #3730A3;
        }
        .badge-delivered {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .badge-cancelled {
            background-color: #FEE2E2;
            color: #B91C1C;
        }
        .badge-return {
            background-color: #F3E8FF;
            color: #6B21A8;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-container {
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal.active .modal-container {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="/" class="text-2xl font-bold text-gray-800">Silver</a>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Home
                        </a>
                        <a href="/products" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Shop
                        </a>
                        <a href="/orders" class="border-indigo-500 text-indigo-600 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Orders
                        </a>
                    </div>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:items-center">
                    <div class="flex items-center space-x-4">
                        <a href="/wishlist" class="p-1 rounded-full text-gray-400 hover:text-gray-500 relative">
                            <i class="fa-regular fa-heart text-lg"></i>
                            {{if gt .WishlistCount 0}}
                            <span class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 rounded-full flex items-center justify-center text-xs text-white">{{.WishlistCount}}</span>
                            {{end}}
                        </a>
                        <a href="/cart" class="p-1 rounded-full text-gray-400 hover:text-gray-500 relative">
                            <i class="fa-solid fa-cart-shopping text-lg"></i>
                            {{if gt .CartCount 0}}
                            <span class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 rounded-full flex items-center justify-center text-xs text-white">{{.CartCount}}</span>
                            {{end}}
                        </a>
                        <div class="ml-3 relative">
                            <div>
                                <button type="button" class="flex text-sm rounded-full focus:outline-none" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                                    {{if .ProfileImage}}
                                    <img class="h-8 w-8 rounded-full object-cover" src="{{.ProfileImage}}" alt="Profile">
                                    {{else}}
                                    <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">
                                        <i class="fa-solid fa-user"></i>
                                    </div>
                                    {{end}}
                                </button>
                            </div>
                            <div class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none" id="user-dropdown">
                                <p class="block px-4 py-2 text-sm text-gray-700 border-b">
                                    Hello, {{.UserName}}
                                </p>
                                <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    Your Profile
                                </a>
                                <a href="/orders" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 bg-gray-50">
                                    Your Orders
                                </a>
                                <a href="/wallet" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    Your Wallet
                                </a>
                                <a href="/logout" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                    Sign out
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="-mr-2 flex items-center sm:hidden">
                    <button type="button" class="mobile-menu-button inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none" aria-expanded="false">
                        <i class="fa-solid fa-bars text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="hidden sm:hidden mobile-menu">
            <div class="pt-2 pb-3 space-y-1">
                <a href="/" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Home</a>
                <a href="/products" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Shop</a>
                <a href="/orders" class="block pl-3 pr-4 py-2 border-l-4 border-indigo-500 text-base font-medium text-indigo-700 bg-indigo-50">Orders</a>
                <a href="/wishlist" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Wishlist</a>
                <a href="/cart" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Cart</a>
                <a href="/profile" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Profile</a>
                <a href="/logout" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-red-600 hover:bg-gray-50 hover:border-gray-300 hover:text-red-700">Sign out</a>
            </div>
        </div>
    </nav>

    <!-- Order List Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Your Orders</h1>
            <div class="relative">
                <input type="text" id="order-search" placeholder="Search orders..." class="w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>

        {{if .Orders}}
        <div class="space-y-6" id="orders-container">
            {{range .Orders}}
            <div class="order-item bg-white rounded-lg shadow overflow-hidden">
                <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900">
                            Order #{{.OrderIdUnique}}
                        </h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">
                            Placed on {{.OrderDate.Format "Jan 02, 2006"}}
                        </p>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="badge 
                            {{if eq .Status "Pending"}}badge-pending
                            {{else if eq .Status "Confirmed"}}badge-confirmed
                            {{else if eq .Status "Shipped"}}badge-shipped
                            {{else if eq .Status "Delivered"}}badge-delivered
                            {{else if eq .Status "Cancelled"}}badge-cancelled
                            {{else}}badge-return{{end}}">
                            {{.Status}}
                        </span>
                        <span class="mt-1 text-sm text-gray-600">${{printf "%.2f" .TotalPrice}}</span>
                    </div>
                </div>
                <div class="border-t border-gray-200">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="space-y-3">
                            {{range .OrderItems}}
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0 h-12 w-12 bg-gray-100 rounded-md overflow-hidden">
                                        {{if .Product.Images}}
                                        <img src="{{(index .Product.Images 0).URL}}" alt="{{.Product.ProductName}}" class="h-full w-full object-cover">
                                        {{else}}
                                        <div class="h-full w-full flex items-center justify-center text-gray-400">
                                            <i class="fa-solid fa-image"></i>
                                        </div>
                                        {{end}}
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">{{.Product.ProductName}}</p>
                                        <p class="text-xs text-gray-500">Qty: {{.Quantity}} × ${{printf "%.2f" .Price}} | {{if ne .Status "Active"}}{{.Status}}{{else}}{{.Product.Category}}{{end}}</p>
                                    </div>
                                </div>
                                <div>
                                    {{if and (eq .Status "Active") (or (eq $.Status "Pending") (eq $.Status "Confirmed"))}}
                                    <button class="cancel-item-btn text-xs text-red-600 hover:text-red-700" data-order="{{$.OrderIdUnique}}" data-item="{{.ID}}">
                                        Cancel Item
                                    </button>
                                    {{end}}
                                </div>
                            </div>
                            {{end}}
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-4 sm:px-6 flex justify-between items-center">
                    <div class="flex space-x-3">
                        <a href="/orders/{{.OrderIdUnique}}" class="inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500">
                            <i class="fa-solid fa-circle-info mr-1"></i> View Details
                        </a>
                        <a href="/orders/{{.OrderIdUnique}}/invoice" class="inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500">
                            <i class="fa-solid fa-file-pdf mr-1"></i> Download Invoice
                        </a>
                    </div>
                    <div class="flex space-x-3">
                        {{if eq .Status "Delivered"}}
                        <button class="return-order-btn inline-flex items-center px-3 py-1.5 border border-indigo-600 text-xs font-medium rounded-md text-indigo-600 bg-white hover:bg-indigo-50" data-order="{{.OrderIdUnique}}">
                            <i class="fa-solid fa-rotate-left mr-1"></i> Return Order
                        </button>
                        {{else if or (eq .Status "Pending") (eq .Status "Confirmed")}}
                        <button class="cancel-order-btn inline-flex items-center px-3 py-1.5 border border-red-600 text-xs font-medium rounded-md text-red-600 bg-white hover:bg-red-50" data-order="{{.OrderIdUnique}}">
                            <i class="fa-solid fa-ban mr-1"></i> Cancel Order
                        </button>
                        {{end}}
                    </div>
                </div>
            </div>
            {{end}}
        </div>
        {{else}}
        <div class="text-center py-12">
            <div class="mx-auto h-24 w-24 text-gray-300">
                <i class="fa-solid fa-box-open text-6xl"></i>
            </div>
            <h3 class="mt-2 text-lg font-medium text-gray-900">No orders yet</h3>
            <p class="mt-1 text-sm text-gray-500">Start shopping to place your first order.</p>
            <div class="mt-6">
                <a href="/products" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Browse Products
                </a>
            </div>
        </div>
        {{end}}
    </div>

    <!-- Cancel Order Modal -->
    <div class="modal fixed inset-0 hidden z-50 flex items-center justify-center bg-black bg-opacity-50" id="cancel-order-modal">
        <div class="modal-container bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-medium text-gray-900">Cancel Order</h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-sm text-gray-600 mb-4">Please provide a reason for cancelling this order.</p>
                <textarea id="cancel-reason" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="3" placeholder="Enter reason for cancellation"></textarea>
                <input type="hidden" id="cancel-order-id">
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                <button id="cancel-modal-close" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                    Close
                </button>
                <button id="confirm-cancel-order" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none">
                    Confirm Cancellation
                </button>
            </div>
        </div>
    </div>

    <!-- Cancel Item Modal -->
    <div class="modal fixed inset-0 hidden z-50 flex items-center justify-center bg-black bg-opacity-50" id="cancel-item-modal">
        <div class="modal-container bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-medium text-gray-900">Cancel Item</h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-sm text-gray-600 mb-4">Please provide a reason for cancelling this item.</p>
                <textarea id="cancel-item-reason" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="3" placeholder="Enter reason for cancellation"></textarea>
                <input type="hidden" id="cancel-item-order-id">
                <input type="hidden" id="cancel-item-id">
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                <button id="cancel-item-modal-close" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                    Close
                </button>
                <button id="confirm-cancel-item" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none">
                    Confirm Cancellation
                </button>
            </div>
        </div>
    </div>

    <!-- Return Order Modal -->
    <div class="modal fixed inset-0 hidden z-50 flex items-center justify-center bg-black bg-opacity-50" id="return-order-modal">
        <div class="modal-container bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-medium text-gray-900">Return Order</h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-sm text-gray-600 mb-4">Please provide a reason for returning this order.</p>
                <textarea id="return-reason" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="3" placeholder="Enter reason for return"></textarea>
                <input type="hidden" id="return-order-id">
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                <button id="return-modal-close" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                    Close
                </button>
                <button id="confirm-return-order" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                    Confirm Return
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 transform transition-all duration-300 translate-y-16 opacity-0">
        <div class="bg-white rounded-lg shadow-lg px-4 py-3 max-w-md flex items-center space-x-3 border-l-4 border-green-500">
            <i class="fa-solid fa-circle-check text-green-500"></i>
            <p class="text-sm font-medium text-gray-900" id="toast-message"></p>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // User dropdown
            const userMenuButton = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown');
            if (userMenuButton && userDropdown) {
                userMenuButton.addEventListener('click', () => {
                    userDropdown.classList.toggle('hidden');
                });
    
                document.addEventListener('click', (event) => {
                    if (!userMenuButton.contains(event.target) && !userDropdown.contains(event.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }

            // Mobile menu
            const mobileMenuButton = document.querySelector('.mobile-menu-button');
            const mobileMenu = document.querySelector('.mobile-menu');
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            // Search orders
            const searchInput = document.getElementById('order-search');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(searchOrders, 300));
            }

            // Cancel order modals
            const cancelOrderButtons = document.querySelectorAll('.cancel-order-btn');
            const cancelOrderModal = document.getElementById('cancel-order-modal');
            const cancelOrderId = document.getElementById('cancel-order-id');
            const cancelModalClose = document.getElementById('cancel-modal-close');
            const confirmCancelOrder = document.getElementById('confirm-cancel-order');

            cancelOrderButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    cancelOrderId.value = btn.dataset.order;
                    cancelOrderModal.classList.remove('hidden');
                    cancelOrderModal.classList.add('active');
                });
            });

            if (cancelModalClose) {
                cancelModalClose.addEventListener('click', () => {
                    cancelOrderModal.classList.add('hidden');
                    cancelOrderModal.classList.remove('active');
                });
            }

            if (confirmCancelOrder) {
                confirmCancelOrder.addEventListener('click', () => {
                    const orderId = cancelOrderId.value;
                    const reason = document.getElementById('cancel-reason').value;
                    
                    if (!reason.trim()) {
                        alert('Please provide a reason for cancellation');
                        return;
                    }
                    
                    cancelOrder(orderId, reason);
                });
            }

            // Cancel item modals
            const cancelItemButtons = document.querySelectorAll('.cancel-item-btn');
            const cancelItemModal = document.getElementById('cancel-item-modal');
            const cancelItemOrderId = document.getElementById('cancel-item-order-id');
            const cancelItemId = document.getElementById('cancel-item-id');
            const cancelItemModalClose = document.getElementById('cancel-item-modal-close');
            const confirmCancelItem = document.getElementById('confirm-cancel-item');

            cancelItemButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    cancelItemOrderId.value = btn.dataset.order;
                    cancelItemId.value = btn.dataset.item;
                    cancelItemModal.classList.remove('hidden');
                    cancelItemModal.classList.add('active');
                });
            });

            if (cancelItemModalClose) {
                cancelItemModalClose.addEventListener('click', () => {
                    cancelItemModal.classList.add('hidden');
                    cancelItemModal.classList.remove('active');
                });
            }

            if (confirmCancelItem) {
                confirmCancelItem.addEventListener('click', () => {
                    const orderId = cancelItemOrderId.value;
                    const itemId = cancelItemId.value;
                    const reason = document.getElementById('cancel-item-reason').value;
                    
                    if (!reason.trim()) {
                        alert('Please provide a reason for cancellation');
                        return;
                    }
                    
                    cancelItem(orderId, itemId, reason);
                });
            }

            // Return order modals
            const returnOrderButtons = document.querySelectorAll('.return-order-btn');
            const returnOrderModal = document.getElementById('return-order-modal');
            const returnOrderId = document.getElementById('return-order-id');
            const returnModalClose = document.getElementById('return-modal-close');
            const confirmReturnOrder = document.getElementById('confirm-return-order');

            returnOrderButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    returnOrderId.value = btn.dataset.order;
                    returnOrderModal.classList.remove('hidden');
                    returnOrderModal.classList.add('active');
                });
            });

            if (returnModalClose) {
                returnModalClose.addEventListener('click', () => {
                    returnOrderModal.classList.add('hidden');
                    returnOrderModal.classList.remove('active');
                });
            }

            if (confirmReturnOrder) {
                confirmReturnOrder.addEventListener('click', () => {
                    const orderId = returnOrderId.value;
                    const reason = document.getElementById('return-reason').value;
                    
                    if (!reason.trim()) {
                        alert('Please provide a reason for return');
                        return;
                    }
                    
                    returnOrder(orderId, reason);
                });
            }

            // Close modals when clicking outside
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.classList.add('hidden');
                        modal.classList.remove('active');
                    }
                });
            });
        });

        function searchOrders(event) {
            const query = event.target.value.trim();
            if (!query) {
                // Reload the page to show all orders
                window.location.reload();
                return;
            }

            fetch(`/orders/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    // Process and display search results
                    updateOrdersDisplay(data);
                })
                .catch(error => {
                    console.error('Error searching orders:', error);
                });
        }

        function updateOrdersDisplay(orders) {
            const container = document.getElementById('orders-container');
            if (!container) return;

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">No orders found matching your search.</p>
                    </div>
                `;
                return;
            }

            // This is simplified, you would need to build HTML similar to your template
            let html = '';
            orders.forEach(order => {
                // Build order HTML based on your template structure
                // This is just a sample structure
                let statusClass = '';
                switch(order.Status) {
                    case 'Pending': statusClass = 'badge-pending'; break;
                    case 'Confirmed': statusClass = 'badge-confirmed'; break;
                    case 'Shipped': statusClass = 'badge-shipped'; break;
                    case 'Delivered': statusClass = 'badge-delivered'; break;
                    case 'Cancelled': statusClass = 'badge-cancelled'; break;
                    default: statusClass = 'badge-return';
                }

                let itemsHtml = '';
                order.OrderItems.forEach(item => {
                    itemsHtml += `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 h-12 w-12 bg-gray-100 rounded-md overflow-hidden">
                                    ${item.Product.Images && item.Product.Images.length ? 
                                        `<img src="${item.Product.Images[0].URL}" alt="${item.Product.ProductName}" class="h-full w-full object-cover">` :
                                        `<div class="h-full w-full flex items-center justify-center text-gray-400">
                                            <i class="fa-solid fa-image"></i>
                                        </div>`
                                    }
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">${item.Product.ProductName}</p>
                                    <p class="text-xs text-gray-500">Qty: ${item.Quantity} × ${item.Price.toFixed(2)} | ${item.Status !== 'Active' ? item.Status : item.Product.Category}</p>
                                </div>
                            </div>
                            <div>
                                ${item.Status === 'Active' && (order.Status === 'Pending' || order.Status === 'Confirmed') ?
                                    `<button class="cancel-item-btn text-xs text-red-600 hover:text-red-700" data-order="${order.OrderIdUnique}" data-item="${item.ID}">
                                        Cancel Item
                                    </button>` : ''
                                }
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div class="order-item bg-white rounded-lg shadow overflow-hidden">
                        <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg leading-6 font-medium text-gray-900">
                                    Order #${order.OrderIdUnique}
                                </h3>
                                <p class="mt-1 max-w-2xl text-sm text-gray-500">
                                    Placed on ${new Date(order.OrderDate).toLocaleDateString('en-US', {month: 'short', day: '2-digit', year: 'numeric'})}
                                </p>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="badge ${statusClass}">
                                    ${order.Status}
                                </span>
                                <span class="mt-1 text-sm text-gray-600">${order.TotalPrice.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="border-t border-gray-200">
                            <div class="px-4 py-5 sm:p-6">
                                <div class="space-y-3">
                                    ${itemsHtml}
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-4 sm:px-6 flex justify-between items-center">
                            <div class="flex space-x-3">
                                <a href="/orders/${order.OrderIdUnique}" class="inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500">
                                    <i class="fa-solid fa-circle-info mr-1"></i> View Details
                                </a>
                                <a href="/orders/${order.OrderIdUnique}/invoice" class="inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500">
                                    <i class="fa-solid fa-file-pdf mr-1"></i> Download Invoice
                                </a>
                            </div>
                            <div class="flex space-x-3">
                                ${order.Status === 'Delivered' ?
                                    `<button class="return-order-btn inline-flex items-center px-3 py-1.5 border border-indigo-600 text-xs font-medium rounded-md text-indigo-600 bg-white hover:bg-indigo-50" data-order="${order.OrderIdUnique}">
                                        <i class="fa-solid fa-rotate-left mr-1"></i> Return Order
                                    </button>` :
                                    (order.Status === 'Pending' || order.Status === 'Confirmed') ?
                                    `<button class="cancel-order-btn inline-flex items-center px-3 py-1.5 border border-red-600 text-xs font-medium rounded-md text-red-600 bg-white hover:bg-red-50" data-order="${order.OrderIdUnique}">
                                        <i class="fa-solid fa-ban mr-1"></i> Cancel Order
                                    </button>` : ''
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Re-attach event listeners to the new elements
            attachEventListeners();
        }

        function attachEventListeners() {
            // Re-attach event listeners for cancel order buttons
            document.querySelectorAll('.cancel-order-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('cancel-order-id').value = btn.dataset.order;
                    document.getElementById('cancel-order-modal').classList.remove('hidden');
                    document.getElementById('cancel-order-modal').classList.add('active');
                });
            });

            // Re-attach event listeners for cancel item buttons
            document.querySelectorAll('.cancel-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('cancel-item-order-id').value = btn.dataset.order;
                    document.getElementById('cancel-item-id').value = btn.dataset.item;
                    document.getElementById('cancel-item-modal').classList.remove('hidden');
                    document.getElementById('cancel-item-modal').classList.add('active');
                });
            });

            // Re-attach event listeners for return order buttons
            document.querySelectorAll('.return-order-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('return-order-id').value = btn.dataset.order;
                    document.getElementById('return-order-modal').classList.remove('hidden');
                    document.getElementById('return-order-modal').classList.add('active');
                });
            });
        }

        function cancelOrder(orderId, reason) {
            fetch(`/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    document.getElementById('cancel-order-modal').classList.add('hidden');
                    document.getElementById('cancel-reason').value = '';
                    showToast(data.message);
                    
                    // Reload the page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    alert(data.error || 'Failed to cancel order');
                }
            })
            .catch(error => {
                console.error('Error cancelling order:', error);
                alert('An error occurred while cancelling the order');
            });
        }

        function cancelItem(orderId, itemId, reason) {
            fetch(`/orders/${orderId}/items/${itemId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    document.getElementById('cancel-item-modal').classList.add('hidden');
                    document.getElementById('cancel-item-reason').value = '';
                    showToast(data.message);
                    
                    // Reload the page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    alert(data.error || 'Failed to cancel item');
                }
            })
            .catch(error => {
                console.error('Error cancelling item:', error);
                alert('An error occurred while cancelling the item');
            });
        }

        function returnOrder(orderId, reason) {
            fetch(`/orders/${orderId}/return`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    document.getElementById('return-order-modal').classList.add('hidden');
                    document.getElementById('return-reason').value = '';
                    showToast(data.message);
                    
                    // Reload the page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    alert(data.error || 'Failed to request return');
                }
            })
            .catch(error => {
                console.error('Error requesting return:', error);
                alert('An error occurred while requesting the return');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            
            toast.classList.remove('translate-y-16', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-16', 'opacity-0');
            }, 3000);
        }

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
    </script>
</body>
</html>