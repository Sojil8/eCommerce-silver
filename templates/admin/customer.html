<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="/static/adminSide/customer.css">
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
            </div>
            <div class="sidebar-menu">
                <a href="#" class="menu-item">Dashboard</a>
                <a href="/admin/user-management" class="menu-item">Customers</a>
                <a href="#" class="menu-item">Orders</a>
                <a href="#" class="menu-item">Products</a>
            </div>
        </div>

        <div class="main-content">
            <h3>Customers</h3>

            <form class="search-form" method="GET" action="/admin/user-management">
                <input type="text" name="search" placeholder="Search for customers...">
                <button type="submit">Search</button>
            </form>

            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone No</th>
                        <th>Action</th>
                        <th>Delete</th> <!-- New Delete Column -->
                    </tr>
                </thead>
                <tbody>
                    {{ range .users }}
                    <tr>
                        <td>{{ .Id }}</td>
                        <td>{{ .UserName }}</td>
                        <td>{{ .Email }}</td>
                        <td>{{ .Phone }}</td>
                        <td>
                            {{ if .Is_blocked }}
                            <button class="btn btn-success block-unblock-btn" data-id="{{ .Id }}"
                                data-action="unblock">Unblock</button>
                            {{ else }}
                            <button class="btn btn-danger block-unblock-btn" data-id="{{ .Id }}"
                                data-action="block">Block</button>
                            {{ end }}
                        </td>
                        <td>
                            <button class="btn btn-danger delete-btn" data-id="{{ .Id }}">Delete</button>
                        </td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>

            <div class="pagination">
                <a href="#" class="active">1</a>
                <a href="#">2</a>
                <a href="#">3</a>
                <a href="#">Next</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const actionButtons = document.querySelectorAll('.block-unblock-btn');
            const deleteButtons = document.querySelectorAll('.delete-btn');

            // Block/Unblock Buttons
            actionButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault(); // Prevent any default action

                    const userId = this.getAttribute('data-id');
                    const action = this.getAttribute('data-action');
                    const url = `/admin/${action}-user/${userId}`;
                    const currentButton = this; // Store reference to the button

                    console.log(`Attempting ${action} for user ${userId}`);

                    // Show immediate feedback
                    currentButton.disabled = true;
                    currentButton.textContent = 'Processing...';

                    fetch(url, {
                        method: 'PATCH',
                        credentials: 'include',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    })
                        .then(response => {
                            console.log(`Response received with status: ${response.status}`);
                            console.log('Response headers:', [...response.headers].map(h => h.join(': ')).join(', '));

                            if (!response.ok) {
                                if (response.status === 401) {
                                    throw new Error('Unauthorized');
                                }
                                throw new Error(`Server returned ${response.status}`);
                            }

                            // Log the response text for debugging
                            return response.text().then(text => {
                                console.log('Raw response text:', text);
                                try {
                                    return JSON.parse(text);
                                } catch (e) {
                                    console.error('JSON parse error:', e);
                                    throw new Error('Invalid JSON in response: ' + text.substring(0, 100));
                                }
                            });
                        })
                        .then(data => {
                            console.log('Data received:', data);

                            // Re-enable button
                            currentButton.disabled = false;

                            if (data.status === 'OK') {
                                console.log('Status update successful, updating UI');

                                // Force DOM update
                                setTimeout(() => {
                                    if (action === 'block') {
                                        currentButton.className = 'btn btn-success block-unblock-btn';
                                        currentButton.textContent = 'Unblock';
                                        currentButton.setAttribute('data-action', 'unblock');
                                        showNotification('User blocked successfully', 'success');
                                    } else {
                                        currentButton.className = 'btn btn-danger block-unblock-btn';
                                        currentButton.textContent = 'Block';
                                        currentButton.setAttribute('data-action', 'block');
                                        showNotification('User unblocked successfully', 'success');
                                    }
                                }, 50);
                            } else {
                                throw new Error(data.message || 'Operation failed');
                            }
                        })
                        .catch(error => {
                            console.error('Error caught:', error);
                            console.error('Error message:', error.message);
                            console.error('Error stack:', error.stack);
                            currentButton.disabled = false;

                            if (error.message === 'Unauthorized') {
                                showNotification('Session expired. Please login again.', 'error');
                                setTimeout(() => window.location.href = '/admin/login', 2000);
                            } else {
                                // Log more details about the button and its state
                                console.log('Button action at error time:', action);
                                console.log('Button current state:', currentButton.outerHTML);

                                // Restore button state - ensure action is defined in this scope
                                const currentAction = currentButton.getAttribute('data-action');
                                if (currentAction === 'block') {
                                    currentButton.textContent = 'Block';
                                } else {
                                    currentButton.textContent = 'Unblock';
                                }

                                // Show a more detailed error message
                                showNotification(`Failed to update user status: ${error.message}`, 'error');
                            }
                        });
                });
            });

            // Delete Buttons
            deleteButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();

                    const userId = this.getAttribute('data-id');
                    const url = `/admin/delete-user/${userId}`;
                    const currentButton = this;

                    if (!confirm('Are you sure you want to delete this user?')) return;

                    currentButton.disabled = true;

                    fetch(url, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                if (response.status === 401) {
                                    throw new Error('Unauthorized');
                                }
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'OK') {
                                currentButton.closest('tr').remove();
                                showNotification('User deleted successfully', 'success');
                            } else {
                                throw new Error(data.message || 'Delete failed');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            currentButton.disabled = false;

                            if (error.message === 'Unauthorized') {
                                showNotification('Session expired. Please login again.', 'error');
                                setTimeout(() => window.location.href = '/admin/login', 2000);
                            } else {
                                showNotification('Failed to delete user', 'error');
                            }
                        });
                });
            });

            function showNotification(message, type) {
                console.log(`Showing notification: ${message} (${type})`);
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.padding = '15px';
                notification.style.borderRadius = '4px';
                notification.style.zIndex = '1000';
                notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
                notification.style.color = 'white';

                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        });
    </script>
</body>

</html>